{{ define "layouts/base" }}
<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .Title }}{{ .Title }} | Krstenica GUI{{ else }}Krstenica GUI{{ end }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --pico-font-family: "Inter", "Segoe UI", sans-serif;
        }
        header {
            margin-bottom: 2rem;
        }
        .actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .layout {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1rem 3rem;
        }
        .page-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        table {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
            background: #fff;
            color: #111;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }
        table thead {
            background: #f5f6f8;
            color: #222;
        }
        table th, table td {
            padding: 0.6rem;
            border-bottom: 1px solid #e5e7eb;
        }
        table tbody tr:hover {
            background: #f9fafb;
        }
        .table-actions {
            display: flex;
            gap: 0.35rem;
        }
        .table-actions button,
        .table-actions a {
            padding: 0.35rem 0.6rem;
            font-size: 0.8rem;
        }
        .input-with-action {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .input-with-action input[readonly] {
            flex: 1;
        }
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: var(--pico-secondary);
            color: white;
        }
        dialog.modal {
            border: none;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 30px 60px rgba(0,0,0,0.2);
        }
        dialog.modal::backdrop {
            background: rgba(15, 23, 42, 0.55);
        }
        .modal article {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .modal section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .modal footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .field-comment {
            font-size: 0.8rem;
            color: #64748b;
            min-height: 1rem;
            margin-top: 0.25rem;
        }
    </style>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>
<body>
    <div class="layout">
        <header>
            <nav>
                <ul>
                    <li><strong>Krstenica</strong></li>
                </ul>
                <ul>
                    <li><a href="/ui">Pocetna</a></li>
                    <li><a href="/ui/krstenice">Krstenice</a></li>
                    <li><a href="/ui/eparhije">Eparhije</a></li>
                    <li><a href="/ui/hramovi">Hramovi</a></li>
                    <li><a href="/ui/svestenici">Svestenici</a></li>
                    <li><a href="/ui/osobe">Osobe</a></li>
                </ul>
            </nav>
        </header>
        <main>
            {{ block "content" . }}
                {{ if eq .ContentTemplate "dashboard/content" }}
                    {{ template "dashboard/content" . }}
                {{ else if eq .ContentTemplate "krstenice/content" }}
                    {{ template "krstenice/content" . }}
                {{ else if eq .ContentTemplate "eparhije/content" }}
                    {{ template "eparhije/content" . }}
                {{ else if eq .ContentTemplate "hramovi/content" }}
                    {{ template "hramovi/content" . }}
                {{ else if eq .ContentTemplate "svestenici/content" }}
                    {{ template "svestenici/content" . }}
                {{ else if eq .ContentTemplate "osobe/content" }}
                    {{ template "osobe/content" . }}
                {{ else }}
                    <p>Stranica nije dostupna.</p>
                {{ end }}
            {{ end }}
        </main>
    </div>
    <script>
        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (!event.target) {
                return;
            }

            var maybeDialog = event.target.matches('dialog') ? event.target : null;
            if (!maybeDialog && event.target.id === 'dialog-root') {
                var dialogs = event.target.querySelectorAll('dialog');
                if (dialogs.length) {
                    maybeDialog = dialogs[dialogs.length - 1];
                }
            }

            if (maybeDialog && !maybeDialog.open && typeof maybeDialog.showModal === 'function') {
                maybeDialog.showModal();
            }
        });
        document.body.addEventListener('click', function (event) {
            if (event.target.matches('[data-close-dialog]')) {
                const dialog = event.target.closest('dialog');
                if (dialog) {
                    dialog.close();
                    dialog.remove();
                }
            }
        });
        document.body.addEventListener('htmx:configRequest', function (event) {
            const form = event.target.closest('[data-json-form]');
            if (!form) {
                return;
            }
            const params = event.detail.parameters;
            const boolFields = ['is_church_married', 'is_twin', 'has_physical_disability'];
            boolFields.forEach(function (name) {
                if (name in params) {
                    const value = params[name];
                    params[name] = value === true || value === 'true';
                    if (params[name] === false && value === '') {
                        delete params[name];
                    }
                }
            });
            const numberFields = ['page', 'current_number', 'eparhija_id', 'tample_id', 'parent_id', 'godfather_id', 'priest_id', 'birth_order', 'number_of_certificate'];
            numberFields.forEach(function (name) {
                if (params[name] !== undefined && params[name] !== '') {
                    params[name] = Number(params[name]);
                } else {
                    delete params[name];
                }
            });
            const dateFields = ['birth_date', 'baptism', 'certificate'];
            dateFields.forEach(function (name) {
                if (params[name]) {
                    const dateValue = new Date(params[name]);
                    if (!isNaN(dateValue.valueOf())) {
                        params[name] = dateValue.toISOString();
                    } else {
                        delete params[name];
                    }
                } else {
                    delete params[name];
                }
            });
            const stringFields = ['book','first_name','last_name','gender','city','country','place_of_birthday','municipality_of_birthday','town_of_certificate','anagrafa'];
            stringFields.forEach(function(name){
                if (params[name] === '') {
                    delete params[name];
                }
            });
            event.detail.parameters = params;
        });

        document.body.addEventListener("person-selected", function (event) {
            const detail = event.detail || {};
            if (!detail.field) {
                return;
            }

            document.querySelectorAll("input[name='" + detail.field + "']").forEach(function (input) {
                input.value = detail.id || "";
            });

            document.querySelectorAll("[data-display-field='" + detail.field + "']").forEach(function (displayInput) {
                const displayValue = detail.label || "";
                if (!displayInput.dataset.originalPlaceholder) {
                    displayInput.dataset.originalPlaceholder = displayInput.getAttribute('placeholder') || '';
                }
                displayInput.value = displayValue;
                displayInput.setAttribute('value', displayValue);
                if (displayValue) {
                    displayInput.setAttribute('placeholder', '');
                } else {
                    displayInput.setAttribute('placeholder', displayInput.dataset.originalPlaceholder);
                }
            });

            document.querySelectorAll("[data-comment-field='" + detail.field + "']").forEach(function (commentElement) {
                commentElement.textContent = detail.label || "";
            });
        });

        document.body.addEventListener("close-picker", function () {
            const pickerDialog = document.querySelector("dialog[data-modal-type='picker']");
            if (pickerDialog) {
                pickerDialog.close();
                pickerDialog.remove();
            }

            const root = document.getElementById('dialog-root');
            if (!root) {
                return;
            }

            const dialogs = root.querySelectorAll('dialog');
            if (!dialogs.length) {
                return;
            }

            const lastDialog = dialogs[dialogs.length - 1];
            if (!lastDialog.open && typeof lastDialog.showModal === 'function') {
                lastDialog.showModal();
            }
        });

        window.refreshEparhijeTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#eparhije-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('eparhije-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('eparhije-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/eparhije/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };

        window.refreshHramoviTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#hramovi-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('hramovi-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('hramovi-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/hramovi/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };

        window.refreshSvesteniciTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#svestenici-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('svestenici-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('svestenici-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/svestenici/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };

        window.refreshOsobeTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#osobe-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('osobe-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('osobe-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/osobe/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };

        window.refreshKrsteniceTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#krstenice-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('krstenice-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('krstenice-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/krstenice/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };
    </script>
</body>
</html>
{{ end }}
