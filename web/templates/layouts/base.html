{{ define "layouts/base" }}
<!DOCTYPE html>
<html lang="sr-Cyrl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .Title }}{{ .Title }} | Крштеница GUI{{ else }}Крштеница GUI{{ end }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --pico-font-family: "Inter", "Segoe UI", sans-serif;
        }
        header {
            margin-bottom: 2rem;
        }
        .actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .layout {
            max-width: 1500px;
            margin: 0 auto;
            padding: 2rem 1rem 3rem;
        }
        .page-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        table {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
            background: #fff;
            color: #111;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }
        table thead {
            background: #f5f6f8;
            color: #222;
        }
        table th, table td {
            padding: 0.6rem;
            border-bottom: 1px solid #e5e7eb;
        }
        table tbody tr:hover {
            background: #f9fafb;
        }
        .table-actions {
            display: flex;
            gap: 0.35rem;
        }
        .table-actions button,
        .table-actions a {
            padding: 0.35rem 0.6rem;
            font-size: 0.8rem;
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            line-height: 1;
        }
        .icon-button svg {
            width: 1rem;
            height: 1rem;
        }
        .input-with-action {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .date-input-control {
            position: relative;
            display: flex;
            align-items: center;
        }
        .date-input-control input {
            flex: 1;
            padding-left: 2.75rem;
        }
        .date-input-icon {
            position: absolute;
            left: 0.35rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            color: #475569;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .date-input-icon svg {
            width: 1.1rem;
            height: 1.1rem;
        }
        .input-with-action input[readonly] {
            flex: 1;
        }
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: var(--pico-secondary);
            color: white;
        }
        .error-message {
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #b91c1c;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
        }
        dialog.modal {
            border: none;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 30px 60px rgba(0,0,0,0.2);
        }
        dialog.modal::backdrop {
            background: rgba(15, 23, 42, 0.55);
        }
        .modal article {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .form-field-connector {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-weight: 600;
            padding-bottom: 0.2rem;
        }
        .modal section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .modal footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .field-comment {
            font-size: 0.8rem;
            color: #64748b;
            min-height: 1rem;
            margin-top: 0.25rem;
        }
        .validation-error {
            font-size: 0.8rem;
            color: #b91c1c;
            margin-top: 0.25rem;
        }
        .validation-error[hidden] {
            display: none;
        }
        .field-error input,
        .field-error .input-with-action input,
        .field-error select,
        .field-error textarea,
        .input-error {
            border-color: #dc2626 !important;
            background: #fef2f2 !important;
        }
        .form-errors {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #b91c1c;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }
        .form-errors[hidden] {
            display: none;
        }
        .logout-form {
            display: inline;
        }
        .logout-form button {
            margin: 0;
        }
    </style>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>
<body>
    <div class="layout">
        <header>
            <nav>
                <ul>
                    <li><strong>Крштеница</strong></li>
                </ul>
                <ul>
                    <li><a href="/ui">Почетна</a></li>
                    <li><a href="/ui/krstenice">Крштенице</a></li>
                    <li><a href="/ui/eparhije">Епархије</a></li>
                    <li><a href="/ui/hramovi">Храмови</a></li>
                    <li><a href="/ui/svestenici">Свештеници</a></li>
                    <li><a href="/ui/osobe">Особе</a></li>
                    <li><a href="/ui/users">Корисници</a></li>
                    <li>
                        <form class="logout-form" method="post" action="/ui/logout">
                            <button type="submit" class="secondary outline">Одјава</button>
                        </form>
                    </li>
                </ul>
            </nav>
        </header>
        <main>
            {{ block "content" . }}
                {{ if eq .ContentTemplate "dashboard/content" }}
                    {{ template "dashboard/content" . }}
                {{ else if eq .ContentTemplate "krstenice/content" }}
                    {{ template "krstenice/content" . }}
                {{ else if eq .ContentTemplate "eparhije/content" }}
                    {{ template "eparhije/content" . }}
                {{ else if eq .ContentTemplate "hramovi/content" }}
                    {{ template "hramovi/content" . }}
                {{ else if eq .ContentTemplate "svestenici/content" }}
                    {{ template "svestenici/content" . }}
                {{ else if eq .ContentTemplate "osobe/content" }}
                    {{ template "osobe/content" . }}
                {{ else if eq .ContentTemplate "users/content" }}
                    {{ template "users/content" . }}
                {{ else }}
                    <p>Страница није доступна.</p>
                {{ end }}
            {{ end }}
        </main>
    </div>
    <script>
        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (!event.target) {
                return;
            }

            var maybeDialog = event.target.matches('dialog') ? event.target : null;
            if (!maybeDialog && event.target.id === 'dialog-root') {
                var dialogs = event.target.querySelectorAll('dialog');
                if (dialogs.length) {
                    maybeDialog = dialogs[dialogs.length - 1];
                }
            }

            if (maybeDialog && !maybeDialog.open && typeof maybeDialog.showModal === 'function') {
                maybeDialog.showModal();
            }
        });
        document.body.addEventListener('click', function (event) {
            if (event.target.matches('[data-close-dialog]')) {
                const dialog = event.target.closest('dialog');
                if (dialog) {
                    dialog.close();
                    dialog.remove();
                }
                return;
            }

            const iconBtn = event.target.closest('[data-open-date-picker]');
            if (!iconBtn) {
                return;
            }
            const control = iconBtn.closest('.date-input-control');
            if (!control) {
                return;
            }
            const input = control.querySelector('input');
            if (!input) {
                return;
            }
            if (typeof input.showPicker === 'function') {
                try {
                    input.showPicker();
                    return;
                } catch (err) {
                    // ignore and focus
                }
            }
            input.focus();
        });

        function parseDateOnlyInput(value) {
            if (value === undefined || value === null) {
                return null;
            }
            var trimmed = String(value).trim();
            if (!trimmed) {
                return null;
            }
            var match = trimmed.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
            if (!match) {
                return null;
            }
            var year = match[1];
            var month = match[2].padStart(2, '0');
            var day = match[3].padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        function parseDateTimeInput(value) {
            if (value === undefined || value === null) {
                return null;
            }
            var trimmed = String(value).trim();
            if (!trimmed) {
                return null;
            }
            var match = trimmed.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})(?:\s+|T)(\d{1,2}):(\d{2})$/);
            if (!match) {
                return null;
            }
            var year = match[1];
            var month = match[2].padStart(2, '0');
            var day = match[3].padStart(2, '0');
            var hours = match[4].padStart(2, '0');
            var minutes = match[5].padStart(2, '0');
            var isoCandidate = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
            var dateValue = new Date(isoCandidate);
            if (isNaN(dateValue.valueOf())) {
                return null;
            }
            return dateValue;
        }
        document.body.addEventListener('htmx:configRequest', function (event) {
            const form = event.target.closest('[data-json-form]');
            if (!form) {
                return;
            }
            const params = event.detail.parameters;
            const boolFields = [];
            const truthyValues = ['true', '1', 'yes', 'y', 'da', 'да'];
            const falsyValues = ['false', '0', 'no', 'n', 'ne', 'не'];
            boolFields.forEach(function (name) {
                if (!(name in params)) {
                    return;
                }
                const value = params[name];
                if (value === true || value === false) {
                    return;
                }
                if (value === '' || value === null || (typeof value === 'string' && value.trim() === '')) {
                    delete params[name];
                    return;
                }
                const normalized = String(value).trim().toLowerCase();
                if (truthyValues.includes(normalized)) {
                    params[name] = true;
                    return;
                }
                if (falsyValues.includes(normalized)) {
                    params[name] = false;
                    return;
                }
                delete params[name];
            });
            const numberFields = ['page', 'current_number', 'eparhija_id', 'tample_id', 'parent_id', 'godfather_id', 'priest_id'];
            numberFields.forEach(function (name) {
                if (params[name] !== undefined && params[name] !== '') {
                    params[name] = Number(params[name]);
                } else {
                    delete params[name];
                }
            });
            const dateTimeFields = ['birth_date'];
            dateTimeFields.forEach(function (name) {
                if (params[name]) {
                    const dateValue = parseDateTimeInput(params[name]);
                    if (dateValue) {
                        params[name] = dateValue.toISOString();
                    } else {
                        delete params[name];
                    }
                } else {
                    delete params[name];
                }
            });
            const isoDateFields = ['certificate'];
            isoDateFields.forEach(function (name) {
                if (params[name]) {
                    const normalizedValue = parseDateOnlyInput(params[name]);
                    if (normalizedValue) {
                        const dateValue = new Date(normalizedValue);
                        if (!isNaN(dateValue.valueOf())) {
                            params[name] = dateValue.toISOString();
                        } else {
                            delete params[name];
                        }
                    } else {
                        delete params[name];
                    }
                } else {
                    delete params[name];
                }
            });
            const dateOnlyFields = ['baptism'];
            dateOnlyFields.forEach(function (name) {
                if (params[name]) {
                    const normalizedValue = parseDateOnlyInput(params[name]);
                    if (normalizedValue) {
                        params[name] = normalizedValue;
                    } else {
                        delete params[name];
                    }
                } else {
                    delete params[name];
                }
            });
            const stringFields = ['book','first_name','gender','city','country','place_of_birthday','municipality_of_birthday','town_of_certificate','anagrafa','birth_order','is_church_married','is_twin','has_physical_disability','number_of_certificate'];
            stringFields.forEach(function(name){
                if (params[name] === '') {
                    delete params[name];
                }
            });
            event.detail.parameters = params;
        });

        const requiredPickerFieldLabels = {
            parent_id: 'Родитељ',
            godfather_id: 'Кум',
            priest_id: 'Свештеник'
        };
        const pickerFieldsCache = new WeakMap();
        const pickerFormState = new WeakMap();

        function getRequiredPickerFields(form) {
            if (!(form instanceof HTMLFormElement)) {
                return [];
            }
            if (pickerFieldsCache.has(form)) {
                return pickerFieldsCache.get(form);
            }
            const attr = form.getAttribute('data-required-picker-fields') || '';
            const fields = attr.split(',').map(function (name) {
                return name.trim();
            }).filter(Boolean);
            pickerFieldsCache.set(form, fields);
            return fields;
        }

        function ensurePickerFormState(form) {
            if (!pickerFormState.has(form)) {
                pickerFormState.set(form, {
                    touched: false,
                    missing: new Set(),
                    summary: form.querySelector('[data-form-errors]') || null
                });
            }
            return pickerFormState.get(form);
        }

        function updatePickerSummary(form, state) {
            if (!state) {
                return;
            }
            let summary = state.summary;
            if (!summary) {
                summary = form.querySelector('[data-form-errors]');
                state.summary = summary || null;
            }
            if (!summary) {
                return;
            }
            if (!state.touched || state.missing.size === 0) {
                summary.hidden = true;
                summary.textContent = '';
                return;
            }
            const labels = Array.from(state.missing).map(function (field) {
                return requiredPickerFieldLabels[field] || field;
            });
            summary.hidden = false;
            summary.textContent = 'Попуните обавезна поља: ' + labels.join(', ') + '.';
        }

        function setPickerFieldVisualState(form, fieldName, isValid, state) {
            const displayInput = form.querySelector('[data-display-field="' + fieldName + '"]');
            const label = displayInput ? displayInput.closest('label') : null;
            const errorElement = form.querySelector('[data-error-field="' + fieldName + '"]');

            if (!isValid) {
                state.missing.add(fieldName);
                if (label) {
                    label.classList.add('field-error');
                }
                if (displayInput) {
                    displayInput.classList.add('input-error');
                }
                if (errorElement) {
                    errorElement.textContent = 'Поље је обавезно';
                    errorElement.hidden = false;
                }
            } else {
                state.missing.delete(fieldName);
                if (label) {
                    label.classList.remove('field-error');
                }
                if (displayInput) {
                    displayInput.classList.remove('input-error');
                }
                if (errorElement) {
                    errorElement.textContent = '';
                    errorElement.hidden = true;
                }
            }

            updatePickerSummary(form, state);
        }

        function validatePickerField(form, fieldName) {
            const hiddenInput = form.querySelector('input[name="' + fieldName + '"]');
            const value = hiddenInput ? String(hiddenInput.value || '').trim() : '';
            const isValid = value !== '';
            const state = ensurePickerFormState(form);
            if (!state.touched) {
                return isValid;
            }
            setPickerFieldVisualState(form, fieldName, isValid, state);
            return isValid;
        }

        function validatePickerFieldsOnSubmit(form) {
            const fields = getRequiredPickerFields(form);
            if (!fields.length) {
                return false;
            }
            const state = ensurePickerFormState(form);
            state.touched = true;
            let hasErrors = false;
            fields.forEach(function (fieldName) {
                const valid = validatePickerField(form, fieldName);
                if (!valid) {
                    hasErrors = true;
                }
            });
            return hasErrors;
        }

        document.addEventListener('submit', function (event) {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) {
                return;
            }
            if (!form.matches('form[data-required-picker-fields]')) {
                return;
            }
            const hasErrors = validatePickerFieldsOnSubmit(form);
            if (!hasErrors) {
                return;
            }
            event.preventDefault();
            event.stopImmediatePropagation();
            const firstInvalid = form.querySelector('.input-error');
            if (firstInvalid && typeof firstInvalid.focus === 'function') {
                firstInvalid.focus();
            }
        }, true);

        document.body.addEventListener("person-selected", function (event) {
            const detail = event.detail || {};
            if (!detail.field) {
                return;
            }

            document.querySelectorAll("input[name='" + detail.field + "']").forEach(function (input) {
                input.value = detail.id || "";
            });

            document.querySelectorAll("[data-display-field='" + detail.field + "']").forEach(function (displayInput) {
                const displayValue = detail.label || "";
                if (!displayInput.dataset.originalPlaceholder) {
                    displayInput.dataset.originalPlaceholder = displayInput.getAttribute('placeholder') || '';
                }
                displayInput.value = displayValue;
                displayInput.setAttribute('value', displayValue);
                if (displayValue) {
                    displayInput.setAttribute('placeholder', '');
                } else {
                    displayInput.setAttribute('placeholder', displayInput.dataset.originalPlaceholder);
                }
            });

            document.querySelectorAll("[data-comment-field='" + detail.field + "']").forEach(function (commentElement) {
                commentElement.textContent = detail.label || "";
            });

            document.querySelectorAll("form[data-required-picker-fields] input[name='" + detail.field + "']").forEach(function (input) {
                const form = input.form;
                if (!form) {
                    return;
                }
                const fields = getRequiredPickerFields(form);
                if (!fields.length || fields.indexOf(detail.field) === -1) {
                    return;
                }
                const state = ensurePickerFormState(form);
                if (!state.touched) {
                    return;
                }
                requestAnimationFrame(function () {
                    validatePickerField(form, detail.field);
                });
            });
        });

        document.body.addEventListener("close-picker", function () {
            const pickerDialog = document.querySelector("dialog[data-modal-type='picker']");
            if (pickerDialog) {
                pickerDialog.close();
                pickerDialog.remove();
            }

            const root = document.getElementById('dialog-root');
            if (!root) {
                return;
            }

            const dialogs = root.querySelectorAll('dialog');
            if (!dialogs.length) {
                return;
            }

            const lastDialog = dialogs[dialogs.length - 1];
            if (!lastDialog.open && typeof lastDialog.showModal === 'function') {
                lastDialog.showModal();
            }
        });

        window.refreshEparhijeTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#eparhije-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('eparhije-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('eparhije-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/eparhije/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };

        window.refreshHramoviTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#hramovi-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('hramovi-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('hramovi-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/hramovi/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };

        window.refreshSvesteniciTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#svestenici-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('svestenici-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('svestenici-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/svestenici/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };

        window.refreshSvesteniciPickerTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            htmx.trigger(document.body, 'refresh-svestenici-picker-table');
        };

        window.refreshOsobeTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#osobe-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('osobe-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('osobe-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/osobe/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };

        window.refreshOsobePickerTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            htmx.trigger(document.body, 'refresh-osobe-picker-table');
        };

        window.refreshKrsteniceTable = function () {
            if (typeof htmx === 'undefined') {
                return;
            }

            var targetSelector = '#krstenice-table';
            var target = document.querySelector(targetSelector);
            if (!target) {
                return;
            }

            var params = new URLSearchParams();

            var defaultsForm = document.getElementById('krstenice-default-state');
            if (defaultsForm) {
                var defaultsData = new FormData(defaultsForm);
                defaultsData.forEach(function (value, key) {
                    if (!params.has(key)) {
                        params.append(key, value);
                    }
                });
            }

            var stateForm = document.getElementById('krstenice-state');
            if (stateForm) {
                var stateData = new FormData(stateForm);
                stateData.forEach(function (value, key) {
                    params.set(key, value);
                });
            }

            var query = params.toString();
            var url = '/ui/krstenice/table' + (query ? '?' + query : '');

            htmx.ajax('GET', url, targetSelector);
        };
    </script>
</body>
</html>
{{ end }}
