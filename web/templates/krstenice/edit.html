{{ define "krstenice/edit.html" }}
<dialog open class="modal">
    <article>
        <header>
            <h2>Измени крштеницу</h2>
        </header>
        <form
            id="krstenica-edit-form"
            hx-put="/api/v1/adminv2/krstenice/{{ .Krstenica.ID }}"
            hx-target="#krstenice-table"
            hx-swap="none"
            hx-include="closest form"
            hx-encoding="json"
            hx-on::after-request="if(event.target!==this){return;}if(event.detail.successful){if(window.refreshKrsteniceTable){window.refreshKrsteniceTable();}var root=document.getElementById('dialog-root');if(root){root.innerHTML='';}}"
            data-json-form
        >
            <section>
                <h4>Основни подаци</h4>
                <div class="form-grid">
                    <label>Књига
                        <input name="book" value="{{ .Krstenica.Book }}" required>
                    </label>
                    <label>Страна књиге
                        <input type="number" name="page" min="1" value="{{ if gt .Krstenica.Page 0 }}{{ .Krstenica.Page }}{{ end }}" required>
                    </label>
                    <label>Текући број
                        <input type="number" name="current_number" min="1" value="{{ if gt .Krstenica.CurrentNumber 0 }}{{ .Krstenica.CurrentNumber }}{{ end }}" required>
                    </label>
                    <label>Име детета
                        <input name="first_name" value="{{ .Krstenica.FirstName }}" required>
                    </label>
                    <label>Презиме детета
                        <input name="last_name" value="{{ .Krstenica.LastName }}" required>
                    </label>
                    <label>Пол детета
                        <input name="gender" value="{{ .Krstenica.Gender }}" placeholder="Мушко / Женско" required>
                    </label>
                    <label>Град
                        <input name="city" value="{{ .Krstenica.City }}">
                    </label>
                    <label>Држава
                        <input name="country" value="{{ .Krstenica.Country }}">
                    </label>
                </div>
            </section>

            <section>
                <h4>Датуми</h4>
                <div class="form-grid">
                    <label>Датум и време рођења
                        <input type="datetime-local" name="birth_date" value="{{ if not (.Krstenica.BirthDate.IsZero) }}{{ .Krstenica.BirthDate.Format "2006-01-02T15:04" }}{{ end }}">
                    </label>
                    <label>Датум и време крштења
                        <input type="datetime-local" name="baptism" value="{{ if not (.Krstenica.Baptism.IsZero) }}{{ .Krstenica.Baptism.Format "2006-01-02T15:04" }}{{ end }}">
                    </label>
                    <label>Рођење - редослед
                        <input name="birth_order" value="{{ .Krstenica.BirthOrder }}" placeholder="Примери: Прво, Близанац А">
                    </label>
                    <label>Датум издавања сертификата
                        <input type="date" name="certificate" value="{{ if not (.Krstenica.Certificate.IsZero) }}{{ .Krstenica.Certificate.Format "2006-01-02" }}{{ end }}">
                    </label>
                </div>
            </section>

            <section>
                <h4>Место рођења</h4>
                <div class="form-grid">
                    <label>Место рођења
                        <input name="place_of_birthday" value="{{ .Krstenica.PlaceOfBirthday }}">
                    </label>
                    <label>Општина рођења
                        <input name="municipality_of_birthday" value="{{ .Krstenica.MunicipalityOfBirthday }}">
                    </label>
                    <label>Место сертификата
                        <input name="town_of_certificate" value="{{ .Krstenica.TownOfCertificate }}">
                    </label>
                </div>
            </section>

            <section>
                <h4>Епархија и храм</h4>
                <div class="form-grid">
                    <label>Епархија
                        <select name="eparhija_id">
                            <option value="">Одабери епархију</option>
                            {{ range .Eparhije }}
                            <option value="{{ .ID }}" {{ if eq (int64Value $.Krstenica.EparhijaId) (printf "%d" .ID) }}selected{{ end }}>{{ .Name }}{{ if .City }} - {{ .City }}{{ end }}</option>
                            {{ end }}
                        </select>
                    </label>
                    <label>Храм
                        <select name="tample_id">
                            <option value="">Одабери храм</option>
                            {{ range .Hramovi }}
                            <option value="{{ .ID }}" {{ if eq (int64Value $.Krstenica.TampleId) (printf "%d" .ID) }}selected{{ end }}>{{ .Name }}{{ if .City }} - {{ .City }}{{ end }}</option>
                            {{ end }}
                        </select>
                    </label>
                    <label>Број сертификата
                        <input type="number" name="number_of_certificate" min="1" value="{{ if gt .Krstenica.NumberOfCertificate 0 }}{{ .Krstenica.NumberOfCertificate }}{{ end }}">
                    </label>
                </div>
            </section>

            <section>
                <h4>Родитељи и кумство</h4>
                <div class="form-grid">
                    {{ $parentLabel := printf "%s %s" .Krstenica.ParentFirstName .Krstenica.ParentLastName }}
                    <label>Родитељ
                        <input type="hidden" name="parent_id" value="{{ int64Value .Krstenica.ParentId }}">
                        <div class="input-with-action">
                            <input type="text" data-display-field="parent_id" placeholder="Није одабрано" value="{{ $parentLabel }}">
                            <button class="secondary"
                                type="button"
                                hx-get="/ui/osobe/picker?field=parent_id"
                                hx-target="body"
                                hx-trigger="click"
                                hx-swap="beforeend">
                                Одабери
                            </button>
                        </div>
                        <p class="field-comment" data-comment-field="parent_id">{{ $parentLabel }}</p>
                    </label>

                    {{ $godfatherLabel := printf "%s %s" .Krstenica.GodfatherFirstName .Krstenica.GodfatherLastName }}
                    <label>Кум
                        <input type="hidden" name="godfather_id" value="{{ int64Value .Krstenica.GodfatherId }}">
                        <div class="input-with-action">
                            <input type="text" data-display-field="godfather_id" placeholder="Није одабрано" value="{{ $godfatherLabel }}">
                            <button class="secondary"
                                type="button"
                                hx-get="/ui/osobe/picker?field=godfather_id"
                                hx-target="body"
                                hx-trigger="click"
                                hx-swap="beforeend">
                                Одабери
                            </button>
                        </div>
                        <p class="field-comment" data-comment-field="godfather_id">{{ $godfatherLabel }}</p>
                    </label>

                    {{ $priestLabel := printf "%s %s" .Krstenica.PriestFirstName .Krstenica.PriestLastName }}
                    <label>Свештеник
                        <input type="hidden" name="priest_id" value="{{ int64Value .Krstenica.PriestId }}">
                        <div class="input-with-action">
                            <input type="text" data-display-field="priest_id" placeholder="Није одабрано" value="{{ $priestLabel }}">
                            <button class="secondary"
                                type="button"
                                hx-get="/ui/svestenici/picker?field=priest_id"
                                hx-target="body"
                                hx-trigger="click"
                                hx-swap="beforeend">
                                Одабери
                            </button>
                        </div>
                        <p class="field-comment" data-comment-field="priest_id">{{ $priestLabel }}</p>
                    </label>
                    <label>Је ли дете црквено брачно?
                        <input name="is_church_married" value="{{ .Krstenica.IsChurchMarried }}" placeholder="Да / Не">
                    </label>
                    <label>Дете је близанац?
                        <input name="is_twin" value="{{ .Krstenica.IsTwin }}" placeholder="Да / Не">
                    </label>
                    <label>Физички недостатак?
                        <input name="has_physical_disability" value="{{ .Krstenica.HasPhysicalDisability }}" placeholder="Да / Не">
                    </label>
                </div>
            </section>

            <section>
                <h4>Остало</h4>
                <div class="form-grid">
                    <label>Страна домовника / анаграф
                        <input name="anagrafa" value="{{ .Krstenica.Anagrafa }}">
                    </label>
                    <label>Статус
                        <select name="status">
                            <option value="">Одабери статус</option>
                            <option value="active" {{ if eq .Krstenica.Status "active" }}selected{{ end }}>Активна</option>
                            <option value="inactive" {{ if eq .Krstenica.Status "inactive" }}selected{{ end }}>Неактивна</option>
                            <option value="deleted" {{ if eq .Krstenica.Status "deleted" }}selected{{ end }}>Обрисана</option>
                        </select>
                    </label>
                </div>
                <label>Напомена
                    <textarea name="comment" rows="3">{{ .Krstenica.Comment }}</textarea>
                </label>
            </section>

            <footer>
                <button type="submit" class="primary">Сачувај промене</button>
                <button type="button" class="secondary" data-close-dialog>Одустани</button>
            </footer>
        </form>
    </article>
</dialog>
<script>
  (function () {
    const pickerButtonSelector = "button[hx-get*='/picker/select/']";

    document.body.addEventListener("click", function (evt) {
      const btn = evt.target.closest(pickerButtonSelector);
      if (!btn) {
        return;
      }

      const hxGet = btn.getAttribute("hx-get");
      if (!hxGet) {
        return;
      }

      const url = new URL(hxGet, window.location.origin);
      const id = url.pathname.split("/").pop();
      const field = url.searchParams.get("field");
      if (!field) {
        return;
      }

      const row = btn.closest("tr");
      const cells = row ? row.children : [];
      const ime = cells[0] ? cells[0].innerText.trim() : "";
      const prezime = cells[1] ? cells[1].innerText.trim() : "";
      const fullName = `${ime} ${prezime}`.trim();

      const displayInput = document.querySelector(`[data-display-field="${field}"]`);
      const hiddenInput = document.querySelector(`[name="${field}"]`);

      if (displayInput) {
        displayInput.value = fullName;
      }
      if (hiddenInput) {
        hiddenInput.value = id;
      }

      const pickerDialog = btn.closest("dialog[data-modal-type='picker']");
      if (pickerDialog) {
        if (typeof pickerDialog.close === "function") {
          pickerDialog.close();
        }
        pickerDialog.remove();
      }
    });

    const form = document.getElementById("krstenica-edit-form");
    if (!form) {
      return;
    }

    form.addEventListener("htmx:configRequest", function (event) {
      if (event.target !== form) {
        return;
      }

      try {
        const payloadCopy = JSON.parse(JSON.stringify(event.detail.parameters || {}));
        console.log("[Измени крштеницу] подаци:", payloadCopy);
      } catch (err) {
        console.warn("[Измени крштеницу] није успело бележење података", err, event.detail.parameters);
      }
    });
  })();
</script>
{{ end }}
