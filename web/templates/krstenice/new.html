{{ define "krstenice/new.html" }}
<dialog open class="modal">
    <article>
        <header>
            <h2>Nova krstenica</h2>
        </header>
        <form
            hx-post="/api/v1/adminv2/krstenice"
            hx-target="#krstenice-table"
            hx-swap="none"
            hx-include="closest form"
            hx-encoding="json"
            hx-on::after-request="if(event.target!==this){return;}if(event.detail.successful){if(window.refreshKrsteniceTable){window.refreshKrsteniceTable();}var root=document.getElementById('dialog-root');if(root){root.innerHTML='';}}"
            data-json-form
        >
            <section>
                <h4>Osnovni podaci</h4>
                <div class="form-grid">
                    <label>Knjiga
                        <input name="book" required>
                    </label>
                    <label>Strana knjige
                        <input type="number" name="page" min="1" required>
                    </label>
                    <label>Tekuci broj
                        <input type="number" name="current_number" min="1" required>
                    </label>
                    <label>Ime deteta
                        <input name="first_name" required>
                    </label>
                    <label>Prezime deteta
                        <input name="last_name" required>
                    </label>
                    <label>Pol deteta
                        <select name="gender" required>
                            <option value="">Odaberi</option>
                            <option value="musko">Musko</option>
                            <option value="zensko">Zensko</option>
                        </select>
                    </label>
                    <label>Grad
                        <input name="city">
                    </label>
                    <label>Drzava
                        <input name="country">
                    </label>
                </div>
            </section>

            <section>
                <h4>Datumi</h4>
                <div class="form-grid">
                    <label>Datum i vreme rodjenja
                        <input type="datetime-local" name="birth_date">
                    </label>
                    <label>Datum i vreme krstenja
                        <input type="datetime-local" name="baptism">
                    </label>
                    <label>Rodjenje - redosled
                        <input type="number" name="birth_order" min="1">
                    </label>
                    <label>Datum izdavanja sertifikata
                        <input type="date" name="certificate">
                    </label>
                </div>
            </section>

            <section>
                <h4>Mesto rodjenja</h4>
                <div class="form-grid">
                    <label>Mesto rodjenja
                        <input name="place_of_birthday">
                    </label>
                    <label>Opcina rodjenja
                        <input name="municipality_of_birthday">
                    </label>
                    <label>Mesto sertifikata
                        <input name="town_of_certificate">
                    </label>
                </div>
            </section>

            <section>
                <h4>Eparhija i hram</h4>
                <div class="form-grid">
                    <label>Eparhija
                        <select name="eparhija_id">
                            <option value="">Odaberi eparhiju</option>
                            {{ range .Eparhije }}
                            <option value="{{ .ID }}">{{ .Name }}{{ if .City }} - {{ .City }}{{ end }}</option>
                            {{ end }}
                        </select>
                    </label>
                    <label>Hram
                        <select name="tample_id">
                            <option value="">Odaberi hram</option>
                            {{ range .Hramovi }}
                            <option value="{{ .ID }}">{{ .Name }}{{ if .City }} - {{ .City }}{{ end }}</option>
                            {{ end }}
                        </select>
                    </label>
                    <label>Broj sertifikata
                        <input type="number" name="number_of_certificate" min="1">
                    </label>
                </div>
            </section>

            <section>
                <h4>Roditelji & Kumstvo</h4>
                <div class="form-grid">
                    <label>Roditelj
                        <input type="hidden" name="parent_id">
                        <div class="input-with-action">
                            <input type="text" data-display-field="parent_id" placeholder="Nije odabrano">
                            <button class="secondary"
                                type="button"
                                hx-get="/ui/osobe/picker?field=parent_id"
                                hx-target="body"
                                hx-trigger="click"
                                hx-swap="beforeend">
                                Odaberi
                            </button>
                        </div>
                        <p class="field-comment" data-comment-field="parent_id"></p>
                    </label>

                    <label>Kum
                        <input type="hidden" name="godfather_id">
                        <div class="input-with-action">
                            <input type="text" data-display-field="godfather_id" placeholder="Nije odabrano">
                            <button class="secondary"
                                type="button"
                                hx-get="/ui/osobe/picker?field=godfather_id"
                                hx-target="body"
                                hx-trigger="click"
                                hx-swap="beforeend">
                                Odaberi
                            </button>
                        </div>
                        <p class="field-comment" data-comment-field="godfather_id"></p>
                    </label>
                    <label>Svestenik
                        <input type="hidden" name="priest_id">
                        <div class="input-with-action">
                            <input type="text" data-display-field="priest_id" placeholder="Nije odabrano">
                            <button class="secondary"
                                type="button"
                                hx-get="/ui/svestenici/picker?field=priest_id"
                                hx-target="body"
                                hx-trigger="click"
                                hx-swap="beforeend">
                                Odaberi
                            </button>
                        </div>
                        <p class="field-comment" data-comment-field="priest_id"></p>
                    </label>
                    <label>Roditelji nisu u braku?
                        <select name="is_church_married">
                            <option value="">Ne poznato</option>
                            <option value="true">DA</option>
                            <option value="false">NE</option>
                        </select>
                    </label>
                    <label>Dete je blizanac?
                        <select name="is_twin">
                            <option value="">Ne poznato</option>
                            <option value="true">DA</option>
                            <option value="false">NE</option>
                        </select>
                    </label>
                    <label>Fizicki nedostatak?
                        <select name="has_physical_disability">
                            <option value="">Ne poznato</option>
                            <option value="true">DA</option>
                            <option value="false">NE</option>
                        </select>
                    </label>
                </div>
            </section>

            <section>
                <h4>Ostalo</h4>
                <div class="form-grid">
                    <label>Strana domovnika / anagraf
                        <input name="anagrafa">
                    </label>
                </div>
                <label>Napomena
                    <textarea name="comment" rows="3"></textarea>
                </label>
            </section>

            <footer>
                <button type="submit" class="primary">Sacuvaj</button>
                <button type="button" class="secondary" data-close-dialog>Odustani</button>
            </footer>
        </form>
    </article>
</dialog>
<script>
  document.body.addEventListener("click", function(evt) {
    const btn = evt.target.closest("button[hx-get*='/ui/osobe/picker/select/']");
    if (!btn) {
      return;
    }

    const url = new URL(btn.getAttribute("hx-get"), window.location.origin);
    const id = url.pathname.split("/").pop();
    const field = url.searchParams.get("field");

    const row = btn.closest("tr");
    const ime = row.children[0].innerText.trim();
    const prezime = row.children[1].innerText.trim();
    const fullName = `${ime} ${prezime}`;

    const displayInput = document.querySelector(`[data-display-field="${field}"]`);
    const hiddenInput = document.querySelector(`[name="${field}"]`);

    if (displayInput) {
      displayInput.value = fullName;
    }
    if (hiddenInput) {
      hiddenInput.value = id;
    }

    const picker = document.querySelector("#osobe-picker-table");
    if (picker) {
      picker.remove();
    }
  });
</script>
<script>
  document.body.addEventListener("click", function(evt) {
    const btn = evt.target.closest("button[hx-get*='/ui/svestenici/picker/select/']");
    if (!btn) {
      return;
    }

    const url = new URL(btn.getAttribute("hx-get"), window.location.origin);
    const id = url.pathname.split("/").pop();
    const field = url.searchParams.get("field");

    const row = btn.closest("tr");
    const ime = row.children[0].innerText.trim();
    const prezime = row.children[1].innerText.trim();
    const fullName = `${ime} ${prezime}`;

    const displayInput = document.querySelector(`[data-display-field="${field}"]`);
    const hiddenInput = document.querySelector(`[name="${field}"]`);

    if (displayInput) {
      displayInput.value = fullName;
    }
    if (hiddenInput) {
      hiddenInput.value = id;
    }

    const picker = document.querySelector("#svestenici-picker-table");
    if (picker) {
      picker.remove();
    }
  });
</script>

{{ end }}
